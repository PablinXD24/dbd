<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BarberTime | Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(20, 20, 35, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --primary: #00f2ff;
            --primary-hover: #00c8d4;
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
            --danger: #ff4b4b;
            --bg-gradient: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Background Effects */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.5;
            animation: float 10s infinite ease-in-out;
        }
        .orb-1 { top: -100px; left: -100px; width: 300px; height: 300px; background: #7000ff; }
        .orb-2 { bottom: -100px; right: -100px; width: 250px; height: 250px; background: #00f2ff; animation-delay: -5s; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(20px); } }

        /* Card Container */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        h1, h2 { margin: 0 0 10px 0; text-align: center; font-weight: 600; }
        h1 { background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: var(--text-muted); text-align: center; font-size: 0.9rem; margin-bottom: 25px; }

        /* Inputs */
        .input-group { margin-bottom: 15px; position: relative; }
        
        input, select {
            width: 100%;
            padding: 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 242, 255, 0.1);
            background: rgba(0, 0, 0, 0.6);
        }

        /* Buttons */
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: #000;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.7; cursor: not-allowed; filter: grayscale(0.5); }
        
        button.secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            margin-top: 10px;
            font-size: 0.9rem;
            text-transform: none;
        }
        button.secondary:hover { background: rgba(255,255,255,0.05); }

        /* Error Message Box */
        .error-box {
            background: rgba(255, 75, 75, 0.1);
            border: 1px solid rgba(255, 75, 75, 0.3);
            color: #ff6b6b;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        .error-box.visible { display: block; animation: shake 0.3s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Grid Slots */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .time-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .time-slot.selected { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }
        .time-slot.disabled { opacity: 0.3; cursor: not-allowed; text-decoration: line-through; }

        /* List Items */
        .appt-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--primary);
        }

        .hidden { display: none !important; }

        /* Mobile specific adjustments */
        @media (max-width: 400px) {
            .glass-card { padding: 20px; }
            h1 { font-size: 1.5rem; }
            .slots-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <div class="glass-card">
        
        <div id="auth-screen">
            <h1>BarberTime</h1>
            <p>Entre para agendar seu estilo.</p>
            
            <div class="input-group">
                <input type="email" id="email" placeholder="Seu E-mail" autocomplete="email">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Sua Senha (m√≠n. 6 d√≠gitos)" autocomplete="current-password">
            </div>
            
            <button id="btnLogin">Entrar</button>
            <button id="btnRegister" class="secondary">Criar Nova Conta</button>
            
            <div id="auth-error" class="error-box"></div>
        </div>

        <div id="client-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span style="font-size: 0.9rem; color:var(--text-muted)">Ol√°, <b style="color:#fff" id="user-name">User</b></span>
                <button id="btnLogout" class="secondary" style="width: auto; padding: 8px 12px; margin:0; font-size:0.75rem;">SAIR</button>
            </div>

            <div style="background: rgba(0,0,0,0.2); border-radius:16px; padding:20px; margin-bottom:20px;">
                <h3 style="margin:0 0 15px 0; font-size:1rem; color:var(--primary);">Novo Agendamento</h3>
                
                <select id="service-select">
                    <option value="Corte Cabelo - R$40">‚úÇÔ∏è Corte Cabelo (R$40)</option>
                    <option value="Barba - R$30">ü™í Barba (R$30)</option>
                    <option value="Completo - R$60">üíé Completo (R$60)</option>
                </select>

                <input type="date" id="date-select" style="margin-top:10px;">

                <div id="slots-container" class="slots-grid">
                    <div style="grid-column: span 3; text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">
                        üëÜ Selecione uma data acima
                    </div>
                </div>

                <div id="confirm-section" class="hidden" style="margin-top:20px;">
                    <button id="btn-confirm-booking">Confirmar Agendamento</button>
                </div>
            </div>

            <h4 style="margin: 0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">Meus Hor√°rios</h4>
            <div id="my-appointments-list" style="max-height: 150px; overflow-y: auto;"></div>
        </div>

        <div id="admin-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:1.2rem; margin:0;">Admin Painel</h2>
                <button id="btnLogoutAdmin" class="secondary" style="width: auto; padding: 8px 12px; margin:0; font-size:0.75rem;">SAIR</button>
            </div>
            <p style="text-align:left; margin-bottom:10px;">Agenda Global:</p>
            <div id="admin-appointments-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // SUA CONFIGURA√á√ÉO
        const firebaseConfig = {
            apiKey: "AIzaSyCHR2POfEPFGG-AbajaEsnBk32bvrru5uM",
            authDomain: "dbyd-5201e.firebaseapp.com",
            projectId: "dbyd-5201e",
            storageBucket: "dbyd-5201e.firebasestorage.app",
            messagingSenderId: "376910752424",
            appId: "1:376910752424:web:d64d958c177bdd01e3f09d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI HELPERS ---
        const ui = {
            authScreen: document.getElementById('auth-screen'),
            clientScreen: document.getElementById('client-screen'),
            adminScreen: document.getElementById('admin-screen'),
            email: document.getElementById('email'),
            pass: document.getElementById('password'),
            errorBox: document.getElementById('auth-error'),
            btnLogin: document.getElementById('btnLogin'),
            btnRegister: document.getElementById('btnRegister')
        };

        let currentUser = null;
        let selectedTime = null;

        // --- TRADU√á√ÉO DE ERROS (UX MELHORADA) ---
        function showError(message) {
            ui.errorBox.innerText = message;
            ui.errorBox.classList.add('visible');
            setTimeout(() => ui.errorBox.classList.remove('visible'), 5000);
        }

        function translateFirebaseError(errorCode) {
            switch(errorCode) {
                case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
                case 'auth/email-already-in-use': return 'Este e-mail j√° est√° cadastrado.';
                case 'auth/invalid-email': return 'Formato de e-mail inv√°lido.';
                case 'auth/wrong-password': return 'Senha incorreta.';
                case 'auth/user-not-found': return 'Usu√°rio n√£o encontrado.';
                case 'auth/internal-error': return 'Erro interno do servidor. Tente novamente.';
                default: return `Erro desconhecido: ${errorCode}`;
            }
        }

        function setLoading(btn, isLoading, textDefault) {
            if(isLoading) {
                btn.disabled = true;
                btn.innerText = "Processando...";
            } else {
                btn.disabled = false;
                btn.innerText = textDefault;
            }
        }

        // --- AUTENTICA√á√ÉO ---
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                ui.authScreen.classList.add('hidden');
                ui.errorBox.classList.remove('visible'); // Limpa erros antigos
                if(user.email === 'admin@barber.com') {
                    showAdminDashboard();
                } else {
                    showClientDashboard(user);
                }
            } else {
                ui.authScreen.classList.remove('hidden');
                ui.clientScreen.classList.add('hidden');
                ui.adminScreen.classList.add('hidden');
            }
        });

        ui.btnLogin.addEventListener('click', async () => {
            setLoading(ui.btnLogin, true, "Entrar");
            try {
                await signInWithEmailAndPassword(auth, ui.email.value, ui.pass.value);
            } catch (error) {
                showError(translateFirebaseError(error.code));
            } finally {
                setLoading(ui.btnLogin, false, "Entrar");
            }
        });

        ui.btnRegister.addEventListener('click', async () => {
            const email = ui.email.value;
            const pass = ui.pass.value;

            // Valida√ß√£o local r√°pida
            if(pass.length < 6) {
                showError("A senha precisa ter no m√≠nimo 6 d√≠gitos!");
                return;
            }

            setLoading(ui.btnRegister, true, "Criar Nova Conta");
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.error(error); // Para debug
                showError(translateFirebaseError(error.code));
            } finally {
                setLoading(ui.btnRegister, false, "Criar Nova Conta");
            }
        });

        const logout = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('btnLogoutAdmin').addEventListener('click', logout);

        // --- L√ìGICA DO CLIENTE ---

        function showClientDashboard(user) {
            ui.clientScreen.classList.remove('hidden');
            document.getElementById('user-name').innerText = user.email.split('@')[0];
            loadMyAppointments(user.uid);
        }

        document.getElementById('date-select').addEventListener('change', async (e) => {
            if(!e.target.value) return;
            loadTimeSlots(e.target.value);
        });

        async function loadTimeSlots(date) {
            const container = document.getElementById('slots-container');
            container.innerHTML = "<div style='grid-column:span 3; text-align:center; font-size:0.8rem;'>Carregando hor√°rios...</div>";

            try {
                const q = query(collection(db, "appointments"), where("date", "==", date));
                const snapshot = await getDocs(q);
                const takenTimes = snapshot.docs.map(doc => doc.data().time);

                container.innerHTML = ""; // Limpar

                for (let i = 9; i < 19; i++) { // 09:00 as 19:00
                    ['00', '30'].forEach(min => {
                        const time = `${i < 10 ? '0'+i : i}:${min}`;
                        const div = document.createElement('div');
                        div.className = 'time-slot';
                        div.innerText = time;

                        if (takenTimes.includes(time)) {
                            div.classList.add('disabled');
                        } else {
                            div.onclick = () => {
                                document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                                div.classList.add('selected');
                                selectedTime = time;
                                document.getElementById('confirm-section').classList.remove('hidden');
                            };
                        }
                        container.appendChild(div);
                    });
                }
            } catch (err) {
                container.innerHTML = "<p style='color:red; font-size:0.8rem;'>Erro ao carregar agenda.</p>";
            }
        }

        document.getElementById('btn-confirm-booking').addEventListener('click', async function() {
            if(!selectedTime) return;
            const btn = this;
            btn.disabled = true; 
            btn.innerText = "Agendando...";

            try {
                await addDoc(collection(db, "appointments"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    service: document.getElementById('service-select').value,
                    date: document.getElementById('date-select').value,
                    time: selectedTime,
                    createdAt: new Date()
                });
                alert("Agendamento realizado!");
                window.location.reload();
            } catch (err) {
                alert("Erro: " + err.message);
                btn.disabled = false;
                btn.innerText = "Confirmar Agendamento";
            }
        });

        function loadMyAppointments(uid) {
            const list = document.getElementById('my-appointments-list');
            const q = query(collection(db, "appointments"), where("userId", "==", uid), orderBy("date"), orderBy("time"));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                if(snapshot.empty) {
                    list.innerHTML = "<p style='font-size:0.8rem; opacity:0.6'>Nenhum agendamento.</p>";
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'appt-item';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:600; font-size:0.9rem;">${data.date} - ${data.time}</div>
                            <div style="font-size:0.8rem; opacity:0.7">${data.service}</div>
                        </div>
                        <button onclick="window.cancel('${docSnap.id}')" style="width:auto; padding:5px 10px; font-size:0.7rem; background:rgba(255,255,255,0.1); margin:0;">‚úñ</button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.cancel = async (id) => {
            if(confirm("Cancelar este hor√°rio?")) await deleteDoc(doc(db, "appointments", id));
        };

        // --- L√ìGICA ADMIN ---
        function showAdminDashboard() {
            ui.adminScreen.classList.remove('hidden');
            const list = document.getElementById('admin-appointments-list');
            const q = query(collection(db, "appointments"), orderBy("date"), orderBy("time"));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'appt-item';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:600; color:var(--primary); font-size:0.9rem;">${data.time} - ${data.date}</div>
                            <div style="font-size:0.8rem;">${data.userEmail}</div>
                            <div style="font-size:0.75rem; opacity:0.6">${data.service}</div>
                        </div>
                        <button onclick="window.cancel('${docSnap.id}')" style="width:auto; padding:5px 10px; background:var(--danger); margin:0; font-size:0.7rem;">Cancelar</button>
                    `;
                    list.appendChild(el);
                });
            });
        }
    </script>
</body>
</html>

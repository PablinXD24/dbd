<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberTime - Agendamento</title>
    <style>
        /* --- CSS: Estilo Dark/Gold --- */
        :root {
            --bg-color: #1a1a1a;
            --card-color: #2c2c2c;
            --text-color: #f5f5f5;
            --accent-color: #d4af37; /* Dourado */
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        h1, h2, h3 { color: var(--accent-color); text-align: center; }

        /* Utilit√°rios de Visibilidade */
        .hidden { display: none !important; }

        /* Inputs e Bot√µes */
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border: none;
            box-sizing: border-box;
        }

        input, select { background: #333; color: white; border: 1px solid #444; }
        
        button {
            background-color: var(--accent-color);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover { filter: brightness(1.1); }
        button.secondary { background-color: #444; color: #fff; }
        button.danger { background-color: var(--danger-color); color: #fff; }

        /* Grid de Hor√°rios */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            background-color: var(--card-color);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .time-slot.selected {
            background-color: var(--accent-color);
            color: #000;
        }

        .time-slot.disabled {
            background-color: #333;
            color: #555;
            border-color: #444;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* Lista de Agendamentos (Card) */
        .appointment-card {
            background: var(--card-color);
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-color);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="auth-screen">
            <h1>BarberTime ‚úÇÔ∏è</h1>
            <p style="text-align:center">Acesse para agendar seu corte</p>
            <input type="email" id="email" placeholder="Seu Email">
            <input type="password" id="password" placeholder="Sua Senha">
            <button id="btnLogin">Entrar</button>
            <button id="btnRegister" class="secondary">Criar Conta</button>
            <p id="auth-error" style="color:var(--danger-color); text-align:center;"></p>
        </div>

        <div id="client-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Ol√°, <span id="user-name">Cliente</span></h3>
                <button id="btnLogout" class="secondary" style="width:auto; padding:5px 10px;">Sair</button>
            </div>
            
            <hr style="border-color:#333">

            <div id="booking-section">
                <h2>Novo Agendamento</h2>
                
                <label>1. Escolha o Servi√ßo:</label>
                <select id="service-select">
                    <option value="Corte Cabelo - R$40">Corte Cabelo (R$40)</option>
                    <option value="Barba - R$30">Barba (R$30)</option>
                    <option value="Completo - R$60">Cabelo + Barba (R$60)</option>
                </select>

                <label>2. Escolha a Data:</label>
                <input type="date" id="date-select">

                <label>3. Escolha o Hor√°rio:</label>
                <div id="slots-container" class="slots-grid">
                    <p style="grid-column: span 3; text-align:center; color:#777;">Selecione uma data para ver hor√°rios.</p>
                </div>

                <div id="confirm-section" class="hidden" style="margin-top:20px;">
                    <p>Resumo: <strong id="summary-text"></strong></p>
                    <button id="btn-confirm-booking">CONFIRMAR AGENDAMENTO</button>
                </div>
            </div>

            <hr style="border-color:#333; margin: 30px 0;">

            <h3>Meus Agendamentos</h3>
            <div id="my-appointments-list">
                </div>
        </div>

        <div id="admin-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Painel do Barbeiro üõ°Ô∏è</h3>
                <button id="btnLogoutAdmin" class="secondary" style="width:auto;">Sair</button>
            </div>
            <p>Visualizando agenda completa em tempo real.</p>
            
            <div id="admin-appointments-list">
                </div>
        </div>
    </div>

    <script type="module">
        // Importa√ß√µes do Firebase v9
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            onSnapshot,
            orderBy,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIGURA√á√ÉO (Sua Config)
        const firebaseConfig = {
            apiKey: "AIzaSyCHR2POfEPFGG-AbajaEsnBk32bvrru5uM",
            authDomain: "dbyd-5201e.firebaseapp.com",
            projectId: "dbyd-5201e",
            storageBucket: "dbyd-5201e.firebasestorage.app",
            messagingSenderId: "376910752424",
            appId: "1:376910752424:web:d64d958c177bdd01e3f09d"
        };

        // Inicializa√ß√£o
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let selectedTime = null;

        // --- DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const clientScreen = document.getElementById('client-screen');
        const adminScreen = document.getElementById('admin-screen');
        
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');
        const errorMsg = document.getElementById('auth-error');

        // --- 1. AUTENTICA√á√ÉO ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authScreen.classList.add('hidden');
                // L√≥gica Simples de Admin: Se o email for admin@barber.com
                if(user.email === 'admin@barber.com') {
                    showAdminDashboard();
                } else {
                    showClientDashboard(user);
                }
            } else {
                authScreen.classList.remove('hidden');
                clientScreen.classList.add('hidden');
                adminScreen.classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .catch(err => errorMsg.innerText = "Erro: " + err.message);
        });

        document.getElementById('btnRegister').addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .catch(err => errorMsg.innerText = "Erro: " + err.message);
        });

        const logout = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('btnLogoutAdmin').addEventListener('click', logout);

        // --- 2. L√ìGICA DO CLIENTE ---

        function showClientDashboard(user) {
            clientScreen.classList.remove('hidden');
            document.getElementById('user-name').innerText = user.email.split('@')[0];
            loadMyAppointments(user.uid);
        }

        // Listener para Data selecionada
        const dateInput = document.getElementById('date-select');
        dateInput.addEventListener('change', async (e) => {
            const date = e.target.value;
            if(!date) return;
            loadTimeSlots(date);
        });

        // Fun√ß√£o principal: Gerar Hor√°rios e checar disponibilidade
        async function loadTimeSlots(date) {
            const container = document.getElementById('slots-container');
            container.innerHTML = "Carregando...";

            // 1. Buscar agendamentos existentes no banco para essa data
            const q = query(collection(db, "appointments"), where("date", "==", date));
            const querySnapshot = await getDocs(q);
            const takenTimes = [];
            querySnapshot.forEach((doc) => {
                takenTimes.push(doc.data().time);
            });

            // 2. Gerar slots (Ex: 09:00 as 18:00)
            const openHour = 9;
            const closeHour = 18;
            container.innerHTML = ""; // Limpar

            for (let i = openHour; i < closeHour; i++) {
                // Hora cheia e meia hora
                const times = [`${i}:00`, `${i}:30`];
                
                times.forEach(time => {
                    // Formatar hora (ex: 9:00 -> 09:00)
                    const formattedTime = time.length === 4 ? '0' + time : time;
                    
                    const btn = document.createElement('div');
                    btn.innerText = formattedTime;
                    btn.classList.add('time-slot');

                    // Verificar se j√° est√° ocupado
                    if(takenTimes.includes(formattedTime)) {
                        btn.classList.add('disabled');
                        btn.title = "Hor√°rio ocupado";
                    } else {
                        btn.onclick = () => selectSlot(formattedTime, btn);
                    }

                    container.appendChild(btn);
                });
            }
        }

        function selectSlot(time, element) {
            // UI: Remover sele√ß√£o anterior
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            selectedTime = time;
            
            // Mostrar bot√£o de confirma√ß√£o
            const service = document.getElementById('service-select').value;
            const date = document.getElementById('date-select').value;
            
            document.getElementById('summary-text').innerText = `${service} em ${date} √†s ${time}`;
            document.getElementById('confirm-section').classList.remove('hidden');
        }

        // Salvar no Banco
        document.getElementById('btn-confirm-booking').addEventListener('click', async () => {
            if(!selectedTime) return;
            
            const service = document.getElementById('service-select').value;
            const date = document.getElementById('date-select').value;

            try {
                await addDoc(collection(db, "appointments"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    service: service,
                    date: date,
                    time: selectedTime,
                    createdAt: new Date()
                });
                
                alert("Agendamento confirmado com sucesso!");
                window.location.reload(); // Recarrega para limpar
            } catch (e) {
                alert("Erro ao agendar: " + e.message);
            }
        });

        // Carregar Meus Agendamentos
        function loadMyAppointments(uid) {
            const list = document.getElementById('my-appointments-list');
            const q = query(
                collection(db, "appointments"), 
                where("userId", "==", uid),
                orderBy("date"), 
                orderBy("time")
            );

            // Ouvinte em tempo real para o cliente tamb√©m
            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                if(snapshot.empty) {
                    list.innerHTML = "<p>Nenhum agendamento futuro.</p>";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.classList.add('appointment-card');
                    item.innerHTML = `
                        <div>
                            <strong>${data.date} √†s ${data.time}</strong><br>
                            <small>${data.service}</small>
                        </div>
                        <button class="danger" style="width:auto; padding:5px 10px; font-size:12px;" onclick="cancelAppt('${docSnap.id}')">X</button>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // Fun√ß√£o Global para cancelar (precisa estar no window para o HTML acessar)
        window.cancelAppt = async (id) => {
            if(confirm("Deseja cancelar este agendamento?")) {
                await deleteDoc(doc(db, "appointments", id));
            }
        };

        // --- 3. L√ìGICA DO ADMIN ---

        function showAdminDashboard() {
            adminScreen.classList.remove('hidden');
            const list = document.getElementById('admin-appointments-list');
            
            // Query simples: Pega tudo ordenado por data
            const q = query(collection(db, "appointments"), orderBy("date"), orderBy("time"));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.classList.add('appointment-card');
                    item.innerHTML = `
                        <div>
                            <strong>${data.date} - ${data.time}</strong><br>
                            <span style="color:#aaa">${data.userEmail}</span><br>
                            <small style="color:var(--accent-color)">${data.service}</small>
                        </div>
                        <button class="danger" style="width:auto;" onclick="cancelAppt('${docSnap.id}')">Cancelar</button>
                    `;
                    list.appendChild(item);
                });
            });
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberTime | Glass Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --accent-color: #00d2ff; /* Ciano Neon */
            --accent-gradient: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            --text-color: #ffffff;
            --danger-color: #ff4b4b;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: #0f0c29;
            background-image: linear-gradient(315deg, #0f0c29 0%, #302b63 74%, #24243e 100%);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* --- BACKGROUND BLOBS (O Segredo do Glassmorphism) --- */
        .background-blobs {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .blob {
            position: absolute;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
        }
        .blob-1 {
            top: -10%; left: -10%; width: 500px; height: 500px;
            background: #ff00cc;
        }
        .blob-2 {
            bottom: -10%; right: -10%; width: 400px; height: 400px;
            background: #333399;
            animation-delay: -5s;
        }
        .blob-3 {
            top: 40%; left: 40%; width: 300px; height: 300px;
            background: #00d2ff;
            opacity: 0.4;
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 50px); }
        }

        /* --- GLASS CONTAINER --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 480px;
            margin: 20px;
            transition: 0.3s;
        }

        h1, h2, h3 { margin-top: 0; text-align: center; font-weight: 600; letter-spacing: 1px;}
        h1 { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- INPUTS & BUTTONS --- */
        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            outline: none;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            border-color: var(--accent-color);
            background: rgba(0, 0, 0, 0.5);
        }

        /* Muda a cor do √≠cone de calend√°rio para branco */
        input[type="date"] { color-scheme: dark; }

        button {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 50px; /* Bot√£o Pill */
            background: var(--accent-gradient);
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            transition: transform 0.2s;
        }

        button:active { transform: scale(0.98); }
        button.secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none; }
        button.danger { background: var(--danger-color); box-shadow: 0 4px 15px rgba(255, 75, 75, 0.3); }

        /* --- GRID DE HOR√ÅRIOS --- */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .time-slot:hover { background: rgba(255, 255, 255, 0.15); border-color: rgba(255,255,255,0.3); }
        
        .time-slot.selected {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
        }

        .time-slot.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            text-decoration: line-through;
            background: transparent;
        }

        /* --- CARDS DE LISTA --- */
        .appointment-card {
            background: rgba(0, 0, 0, 0.2);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .label { font-size: 0.85rem; color: #aaa; margin-left: 5px; }

    </style>
</head>
<body>

    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="glass-card">
        
        <div id="auth-screen">
            <h1>BarberTime</h1>
            <p class="text-center" style="opacity: 0.8">Agendamento Exclusivo</p>
            
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Senha">
            
            <button id="btnLogin">ENTRAR</button>
            <button id="btnRegister" class="secondary">CRIAR CONTA</button>
            
            <p id="auth-error" class="text-center" style="color:var(--danger-color); margin-top:10px;"></p>
        </div>

        <div id="client-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <span style="font-size: 1.2rem;">Ol√°, <b id="user-name">...</b> üëã</span>
                <button id="btnLogout" class="secondary" style="width:auto; padding: 8px 15px; margin:0; font-size:0.8rem">Sair</button>
            </div>
            
            <div id="booking-section">
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;">
                    <h3 style="text-align: left; font-size: 1rem; margin-bottom: 15px;">Novo Corte</h3>
                    
                    <span class="label">Servi√ßo</span>
                    <select id="service-select">
                        <option value="Corte Cabelo - R$40">‚úÇÔ∏è Corte Cabelo (R$40)</option>
                        <option value="Barba - R$30">ü™í Barba (R$30)</option>
                        <option value="Completo - R$60">üíé Cabelo + Barba (R$60)</option>
                    </select>

                    <span class="label">Data Desejada</span>
                    <input type="date" id="date-select">

                    <div id="slots-container" class="slots-grid">
                        <p style="grid-column: span 3; text-align:center; opacity:0.5; font-size:0.9rem;">Selecione a data acima.</p>
                    </div>

                    <div id="confirm-section" class="hidden" style="margin-top:15px; text-align: center;">
                        <p style="font-size: 0.9rem;">Agendar para: <br><strong id="summary-text" style="color: var(--accent-color)"></strong>?</p>
                        <button id="btn-confirm-booking">CONFIRMAR</button>
                    </div>
                </div>
            </div>

            <h3 style="text-align: left; margin-top: 30px; font-size: 1rem;">Meus Agendamentos</h3>
            <div id="my-appointments-list" style="max-height: 200px; overflow-y: auto; padding-right:5px;">
                </div>
        </div>

        <div id="admin-screen" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h3 style="margin:0">Admin Panel üõ°Ô∏è</h3>
                <button id="btnLogoutAdmin" class="secondary" style="width:auto; padding: 8px 15px; margin:0; font-size:0.8rem">Sair</button>
            </div>
            
            <div id="admin-appointments-list" style="max-height: 500px; overflow-y: auto;">
                <p class="text-center">Carregando agenda...</p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHR2POfEPFGG-AbajaEsnBk32bvrru5uM",
            authDomain: "dbyd-5201e.firebaseapp.com",
            projectId: "dbyd-5201e",
            storageBucket: "dbyd-5201e.firebasestorage.app",
            messagingSenderId: "376910752424",
            appId: "1:376910752424:web:d64d958c177bdd01e3f09d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedTime = null;

        const authScreen = document.getElementById('auth-screen');
        const clientScreen = document.getElementById('client-screen');
        const adminScreen = document.getElementById('admin-screen');
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');
        const errorMsg = document.getElementById('auth-error');

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authScreen.classList.add('hidden');
                if(user.email === 'admin@barber.com') {
                    showAdminDashboard();
                } else {
                    showClientDashboard(user);
                }
            } else {
                authScreen.classList.remove('hidden');
                clientScreen.classList.add('hidden');
                adminScreen.classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .catch(err => errorMsg.innerText = "Erro: " + err.message);
        });

        document.getElementById('btnRegister').addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .catch(err => errorMsg.innerText = "Erro: " + err.message);
        });

        const logout = () => signOut(auth).then(() => window.location.reload());
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('btnLogoutAdmin').addEventListener('click', logout);

        function showClientDashboard(user) {
            clientScreen.classList.remove('hidden');
            document.getElementById('user-name').innerText = user.email.split('@')[0];
            loadMyAppointments(user.uid);
        }

        const dateInput = document.getElementById('date-select');
        dateInput.addEventListener('change', async (e) => {
            const date = e.target.value;
            if(!date) return;
            loadTimeSlots(date);
        });

        async function loadTimeSlots(date) {
            const container = document.getElementById('slots-container');
            container.innerHTML = "<p style='grid-column:span 3; text-align:center'>Verificando agenda...</p>";

            const q = query(collection(db, "appointments"), where("date", "==", date));
            const querySnapshot = await getDocs(q);
            const takenTimes = [];
            querySnapshot.forEach((doc) => {
                takenTimes.push(doc.data().time);
            });

            const openHour = 9;
            const closeHour = 18;
            container.innerHTML = "";

            for (let i = openHour; i < closeHour; i++) {
                const times = [`${i}:00`, `${i}:30`];
                times.forEach(time => {
                    const formattedTime = time.length === 4 ? '0' + time : time;
                    const btn = document.createElement('div');
                    btn.innerText = formattedTime;
                    btn.classList.add('time-slot');

                    if(takenTimes.includes(formattedTime)) {
                        btn.classList.add('disabled');
                    } else {
                        btn.onclick = () => selectSlot(formattedTime, btn);
                    }
                    container.appendChild(btn);
                });
            }
        }

        function selectSlot(time, element) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
            const service = document.getElementById('service-select').value;
            const date = document.getElementById('date-select').value;
            document.getElementById('summary-text').innerText = `${service} \n ${date} √†s ${time}`;
            document.getElementById('confirm-section').classList.remove('hidden');
        }

        document.getElementById('btn-confirm-booking').addEventListener('click', async () => {
            if(!selectedTime) return;
            const service = document.getElementById('service-select').value;
            const date = document.getElementById('date-select').value;

            try {
                await addDoc(collection(db, "appointments"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    service: service,
                    date: date,
                    time: selectedTime,
                    createdAt: new Date()
                });
                alert("Agendado com sucesso!");
                window.location.reload();
            } catch (e) {
                alert("Erro: " + e.message);
            }
        });

        function loadMyAppointments(uid) {
            const list = document.getElementById('my-appointments-list');
            const q = query(collection(db, "appointments"), where("userId", "==", uid), orderBy("date"), orderBy("time"));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                if(snapshot.empty) {
                    list.innerHTML = "<p style='text-align:center; opacity:0.6'>Sem agendamentos.</p>";
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.classList.add('appointment-card');
                    item.innerHTML = `
                        <div>
                            <strong>${data.date} √†s ${data.time}</strong><br>
                            <small>${data.service}</small>
                        </div>
                        <button class="danger" style="width:auto; padding:5px 12px; margin-top:0" onclick="cancelAppt('${docSnap.id}')">X</button>
                    `;
                    list.appendChild(item);
                });
            });
        }

        window.cancelAppt = async (id) => {
            if(confirm("Cancelar agendamento?")) {
                await deleteDoc(doc(db, "appointments", id));
            }
        };

        function showAdminDashboard() {
            adminScreen.classList.remove('hidden');
            const list = document.getElementById('admin-appointments-list');
            const q = query(collection(db, "appointments"), orderBy("date"), orderBy("time"));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const item = document.createElement('div');
                    item.classList.add('appointment-card');
                    item.innerHTML = `
                        <div>
                            <strong>${data.date} - ${data.time}</strong><br>
                            <span style="opacity:0.7; font-size:0.9em">${data.userEmail}</span><br>
                            <small style="color:var(--accent-color)">${data.service}</small>
                        </div>
                        <button class="danger" style="width:auto; margin:0;" onclick="cancelAppt('${docSnap.id}')">X</button>
                    `;
                    list.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BarberTime | Glass</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00d2ff;
            --primary-dark: #009bbd;
            --danger: #ff4757;
            --glass-bg: rgba(255, 255, 255, 0.07);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-blur: blur(20px);
            --text-main: #ffffff;
            --text-sec: #a4b0be;
            --bg-gradient: radial-gradient(circle at top left, #1e272e, #000000);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            padding: 20px;
        }

        /* --- BACKGROUND FX --- */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(90px);
            z-index: -1;
            opacity: 0.6;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #3742fa; animation: float 10s infinite alternate; }
        .orb-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #e056fd; animation: float 12s infinite alternate-reverse; }

        @keyframes float { from { transform: translate(0,0); } to { transform: translate(20px, 40px); } }

        /* --- GLASS CARD --- */
        .app-container {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        h1, h2, h3 { margin: 0 0 15px 0; text-align: center; font-weight: 700; letter-spacing: -0.5px; }
        h1 span { background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .subtitle { text-align: center; color: var(--text-sec); margin-bottom: 25px; font-size: 0.9rem; }

        /* --- INPUTS & BUTTONS --- */
        .field-group { margin-bottom: 12px; }
        
        input, select {
            width: 100%;
            padding: 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
        }
        input:focus, select:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        input[type="date"] { color-scheme: dark; }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }
        
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.7; cursor: wait; transform: none; }

        .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .btn-secondary:hover { background: rgba(255,255,255,0.05); }

        .btn-danger { background: rgba(255, 71, 87, 0.2); color: var(--danger); font-size: 0.8rem; padding: 6px 12px; width: auto; }

        /* --- ALERTS --- */
        .alert-box {
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }
        .alert-error { background: rgba(255, 71, 87, 0.15); color: #ff6b81; border: 1px solid rgba(255, 71, 87, 0.3); }

        /* --- GRID & LISTS --- */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .slot {
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .slot.available:hover { border-color: var(--primary); }
        .slot.selected { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }
        .slot.disabled { opacity: 0.3; cursor: not-allowed; text-decoration: line-through; }

        .list-item {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--primary);
        }

        .hidden { display: none !important; }
        
        /* Mobile Fixes */
        @media(max-width: 400px) {
            .app-container { padding: 20px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <div class="app-container">
        
        <section id="screen-auth">
            <h1>Barber<span>Time</span></h1>
            <p class="subtitle">Fa√ßa login para garantir seu estilo.</p>
            
            <div class="field-group">
                <input type="email" id="inp-email" placeholder="E-mail">
            </div>
            <div class="field-group">
                <input type="password" id="inp-pass" placeholder="Senha (m√≠n. 6 d√≠gitos)">
            </div>

            <button id="btn-login" class="btn-primary">ENTRAR</button>
            <button id="btn-register" class="btn-secondary">CRIAR CONTA</button>

            <div id="auth-alert" class="alert-box alert-error"></div>
        </section>

        <section id="screen-client" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span style="font-size:0.9rem; color:var(--text-sec)">Ol√°, <strong style="color:#fff" id="user-name">...</strong></span>
                <button id="btn-logout" class="btn-secondary" style="width:auto; padding:8px 16px; margin:0; font-size:0.8rem;">Sair</button>
            </div>

            <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:16px;">
                <h3 style="text-align:left; font-size:1rem; color:var(--primary)">Novo Corte</h3>
                
                <select id="sel-service">
                    <option value="Corte Cabelo">‚úÇÔ∏è Corte Cabelo (R$40)</option>
                    <option value="Barba">ü™í Barba (R$30)</option>
                    <option value="Completo">üíé Cabelo + Barba (R$60)</option>
                </select>

                <input type="date" id="sel-date" style="margin-top:10px;">

                <div id="slots-container" class="slots-grid">
                    <div style="grid-column: span 3; text-align:center; padding:20px; opacity:0.6; font-size:0.8rem;">
                        Selecione a data acima para ver hor√°rios.
                    </div>
                </div>

                <button id="btn-confirm" class="btn-primary hidden" style="margin-top:20px;">CONFIRMAR AGENDAMENTO</button>
            </div>

            <h3 style="text-align:left; font-size:1rem; margin-top:25px;">Meus Hor√°rios</h3>
            <div id="my-list" style="max-height:150px; overflow-y:auto;">
                </div>
        </section>

        <section id="screen-admin" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:1.2rem; margin:0;">Painel Admin</h2>
                <button id="btn-logout-admin" class="btn-secondary" style="width:auto; padding:8px 16px; margin:0; font-size:0.8rem;">Sair</button>
            </div>
            
            <p class="subtitle" style="text-align:left;">Agenda Completa (Tempo Real)</p>
            <div id="admin-list" style="max-height:400px; overflow-y:auto;">
                <div style="text-align:center; padding:20px;">Carregando agenda...</div>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        // IMPORTANTE: initializeFirestore para corrigir CORS
        import { 
            getFirestore, initializeFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, deleteDoc, doc 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHR2POfEPFGG-AbajaEsnBk32bvrru5uM",
            authDomain: "dbyd-5201e.firebaseapp.com",
            projectId: "dbyd-5201e",
            storageBucket: "dbyd-5201e.firebasestorage.app",
            messagingSenderId: "376910752424",
            appId: "1:376910752424:web:d64d958c177bdd01e3f09d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- CORRE√á√ÉO DE CONEX√ÉO (LONG POLLING) ---
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true,
            useFetchStreams: false
        });

        // --- VARI√ÅVEIS DE ESTADO ---
        let currentUser = null;
        let selectedTime = null;

        // --- UI ELEMENTS ---
        const els = {
            authScreen: document.getElementById('screen-auth'),
            clientScreen: document.getElementById('screen-client'),
            adminScreen: document.getElementById('screen-admin'),
            email: document.getElementById('inp-email'),
            pass: document.getElementById('inp-pass'),
            alert: document.getElementById('auth-alert'),
            slots: document.getElementById('slots-container'),
            confirmBtn: document.getElementById('btn-confirm'),
            adminList: document.getElementById('admin-list'),
            clientList: document.getElementById('my-list')
        };

        // --- HELPERS ---
        const showAlert = (msg) => {
            els.alert.innerText = msg;
            els.alert.style.display = 'block';
            setTimeout(() => els.alert.style.display = 'none', 5000);
        };

        const translateError = (code) => {
            const errors = {
                'auth/invalid-email': 'E-mail inv√°lido.',
                'auth/user-not-found': 'Usu√°rio n√£o encontrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/email-already-in-use': 'E-mail j√° cadastrado.',
                'auth/weak-password': 'Senha muito fraca (m√≠n. 6 d√≠gitos).',
                'auth/internal-error': 'Erro interno. Verifique o console.'
            };
            return errors[code] || `Erro: ${code}`;
        };

        const setLoading = (btnId, loading, text) => {
            const btn = document.getElementById(btnId);
            btn.disabled = loading;
            btn.innerText = loading ? '...' : text;
        };

        // --- 1. AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                els.authScreen.classList.add('hidden');
                if (user.email === 'admin@barber.com') {
                    els.adminScreen.classList.remove('hidden');
                    loadAdminData();
                } else {
                    els.clientScreen.classList.remove('hidden');
                    document.getElementById('user-name').innerText = user.email.split('@')[0];
                    loadClientData(user.uid);
                }
            } else {
                els.authScreen.classList.remove('hidden');
                els.clientScreen.classList.add('hidden');
                els.adminScreen.classList.add('hidden');
            }
        });

        document.getElementById('btn-login').addEventListener('click', async () => {
            setLoading('btn-login', true);
            try {
                await signInWithEmailAndPassword(auth, els.email.value, els.pass.value);
            } catch (e) {
                showAlert(translateError(e.code));
            } finally {
                setLoading('btn-login', false, 'ENTRAR');
            }
        });

        document.getElementById('btn-register').addEventListener('click', async () => {
            if (els.pass.value.length < 6) return showAlert("A senha deve ter 6+ d√≠gitos.");
            setLoading('btn-register', true);
            try {
                await createUserWithEmailAndPassword(auth, els.email.value, els.pass.value);
            } catch (e) {
                showAlert(translateError(e.code));
            } finally {
                setLoading('btn-register', false, 'CRIAR CONTA');
            }
        });

        const logout = () => signOut(auth).then(() => location.reload());
        document.getElementById('btn-logout').addEventListener('click', logout);
        document.getElementById('btn-logout-admin').addEventListener('click', logout);

        // --- 2. L√ìGICA DO CLIENTE ---
        
        // Define data m√≠nima como HOJE
        const dateInput = document.getElementById('sel-date');
        dateInput.min = new Date().toISOString().split("T")[0];

        dateInput.addEventListener('change', async (e) => {
            const date = e.target.value;
            if (!date) return;
            
            els.slots.innerHTML = '<div style="grid-column:span 3; text-align:center">Buscando hor√°rios...</div>';
            els.confirmBtn.classList.add('hidden');
            selectedTime = null;

            try {
                // Busca hor√°rios j√° ocupados
                const q = query(collection(db, "appointments"), where("date", "==", date));
                const snap = await getDocs(q);
                const taken = snap.docs.map(d => d.data().time);

                els.slots.innerHTML = '';
                
                // Gera hor√°rios das 09:00 as 19:00
                for (let h = 9; h < 19; h++) {
                    ['00', '30'].forEach(m => {
                        const time = `${h < 10 ? '0'+h : h}:${m}`;
                        const div = document.createElement('div');
                        div.className = 'slot';
                        div.innerText = time;
                        
                        if (taken.includes(time)) {
                            div.classList.add('disabled');
                        } else {
                            div.classList.add('available');
                            div.onclick = () => {
                                document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
                                div.classList.add('selected');
                                selectedTime = time;
                                els.confirmBtn.classList.remove('hidden');
                            };
                        }
                        els.slots.appendChild(div);
                    });
                }
            } catch (err) {
                els.slots.innerHTML = '<div style="color:#ff6b81; grid-column:span 3; text-align:center">Erro de Conex√£o com o Banco.</div>';
                console.error(err);
            }
        });

        els.confirmBtn.addEventListener('click', async () => {
            if (!selectedTime) return;
            const btn = els.confirmBtn;
            btn.disabled = true; btn.innerText = "AGENDANDO...";

            try {
                await addDoc(collection(db, "appointments"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    service: document.getElementById('sel-service').value,
                    date: dateInput.value,
                    time: selectedTime,
                    createdAt: new Date()
                });
                alert("Agendamento Confirmado! ‚úÇÔ∏è");
                location.reload();
            } catch (e) {
                alert("Erro: " + e.message);
                btn.disabled = false; btn.innerText = "CONFIRMAR AGENDAMENTO";
            }
        });

        function loadClientData(uid) {
            const q = query(collection(db, "appointments"), where("userId", "==", uid), orderBy("date"), orderBy("time"));
            onSnapshot(q, (snap) => {
                els.clientList.innerHTML = '';
                if (snap.empty) els.clientList.innerHTML = '<p style="text-align:center; font-size:0.8rem; opacity:0.5">Sem agendamentos.</p>';
                
                snap.forEach(d => {
                    const data = d.data();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div>
                            <strong>${data.date.split('-').reverse().join('/')} - ${data.time}</strong><br>
                            <small>${data.service}</small>
                        </div>
                        <button class="btn-danger" onclick="window.delItem('${d.id}')">X</button>
                    `;
                    els.clientList.appendChild(item);
                });
            });
        }

        // --- 3. L√ìGICA DO ADMIN ---
        function loadAdminData() {
            const q = query(collection(db, "appointments"), orderBy("date"), orderBy("time"));
            onSnapshot(q, (snap) => {
                els.adminList.innerHTML = '';
                if (snap.empty) els.adminList.innerHTML = '<p style="text-align:center">Agenda vazia.</p>';

                snap.forEach(d => {
                    const data = d.data();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div>
                            <strong style="color:var(--primary)">${data.time}</strong> - ${data.date.split('-').reverse().join('/')}<br>
                            <span>${data.userEmail}</span><br>
                            <small style="opacity:0.7">${data.service}</small>
                        </div>
                        <button class="btn-danger" onclick="window.delItem('${d.id}')">Cancelar</button>
                    `;
                    els.adminList.appendChild(item);
                });
            });
        }

        // Fun√ß√£o Global para deletar (acess√≠vel no HTML)
        window.delItem = async (id) => {
            if (confirm("Deseja cancelar este agendamento?")) {
                await deleteDoc(doc(db, "appointments", id));
            }
        };

    </script>
</body>
</html>
